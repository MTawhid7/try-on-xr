# Physics Optimization Plan

## Goal Description
Reduce frame time from ~100ms to <20ms to achieve 50-60 FPS. Identify and eliminate bottlenecks in Narrow Phase collision detection and Constraint solving.

## User Review Required
> [!IMPORTANT]
> **SIMD Requirement**: We will enable `simd128` instructions. This requires the browser to support WASM SIMD (standard in modern browsers).
> **Parallelization Strategy**: This plan focuses on single-threaded SIMD and algorithmic improvements first. True multi-threading (Rayon) requires significant build infrastructure changes (SharedArrayBuffer) and is deferred to Phase 2 if needed.

## Proposed Changes

### Phase 1: SIMD & Configuration (Immediate)

#### [physics]
Enable SIMD support and tune solver parameters.

##### [MODIFY] [Cargo.toml](file:///Users/tawhid/Documents/Codes/vestra-physics/physics/Cargo.toml)
- Enable `glam/fast-math` or `glam/simd` (check `glam` docs for WASM).
- Ensure `target-feature=+simd128` is used in build.

##### [MODIFY] [simulation.rs](file:///Users/tawhid/Documents/Codes/vestra-physics/physics/src/engine/simulation.rs)
- Tuning: Reduce default `substeps` from 6 to 4 (trade-off: slightly less stiff constraints).
- Tuning: Reduce `solver_iterations` from 12 to 8 (trade-off: slightly more elastic).

### Phase 2: Narrow Phase Optimization (The Big Win)

#### [physics/collision]
Optimize the [perform_narrow_phase](file:///Users/tawhid/Documents/Codes/vestra-physics/physics/src/collision/resolver/narrow.rs#9-102) hot path.

##### [MODIFY] [narrow.rs](file:///Users/tawhid/Documents/Codes/vestra-physics/physics/src/collision/resolver/narrow.rs)
- **Refactor**: Rewrite `intersect_segment` and `closest_point` to use explicit `f32x4` SIMD where possible if `glam` isn't enough.
- **Optimization**: Add an early-out AABB check *before* the triangle intersection test (scalar check is faster than vector math).
- **Optimization**: Prefetch triangle data if possible (flatten `Triangle` struct).

### Phase 3: Constraint Optimization

#### [physics/constraints]
Clean up "Fake SIMD" unrolling.

##### [MODIFY] [area.rs](file:///Users/tawhid/Documents/Codes/vestra-physics/physics/src/systems/constraints/area.rs)
- Remove manual loop unrolling (4x).
- Simplify logic to allow `rustc` auto-vectorization.

##### [MODIFY] [bending.rs](file:///Users/tawhid/Documents/Codes/vestra-physics/physics/src/systems/constraints/bending.rs)
- Remove manual loop unrolling (4x).
- Simplify logic.

## Verification Plan

### Automated Tests
- Run existing physics tests: `cargo test -p garment-physics`
- Verify no regression in stability.

### Manual Verification
- **Profiler**: Use the existing `ProfilerOverlay` in the web app.
- **Target**:
    - Reduced Frame Total: < 33ms (30 FPS) initially.
    - Narrow Phase: < 20ms.
    - Constraints: < 10ms.
- **Visual Check**: Ensure cloth doesn't explode or pass through the mannequin (due to reduced substeps).
